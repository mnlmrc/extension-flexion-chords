blocks = linspace(1, 30, 30);

for block=blocks
    nii_file = sprintf('/cifs/diedrichsen/data/Chord_exp/EFC_learningfMRI/imaging_data/subj101/usubj101_run_%2d.nii', block);
    V = spm_vol(nii_file);
    Y = spm_read_vols(V);
    [nx, ny, nz, nt] = size(Y);    % nt = number of timepoints (scans)
    Y2D = reshape(Y, [], nt)'; 

    Y_raw = [Y_raw; Y2]
    
    % Suppose you want voxel at location (x=40, y=32, z=22)
    x = 63; y = 14; z = 29;
    
    % Convert to voxel_id
    voxel_id = sub2ind([nx, ny, nz], x, y, z);
    
    % Now extract the timecourse
    timecourse = Y2D(:, voxel_id);
    
    load('/cifs/diedrichsen/data/Chord_exp/EFC_learningfMRI/glm1/subj101/SPM.mat')
    
    K = spm_filter(struct(...
        'RT', 1, ...
        'row', 1:nt, ...
        'HParam', 128));
    
    Y_filt = spm_filter(K, Y2D);
    
    if any(isnan(Y_filt(:))) || any(isinf(Y_filt(:)))
        warning('Filtered data contains NaNs or Infs');
    end
    
    hold on
    timecourse_filt = Y_filt(:, voxel_id);
    
    % Optional: plot it
    plot(timecourse); title(sprintf('Timecourse at voxel (%d, %d, %d)', x, y, z));
    plot(timecourse_filt)
end
